/**
 * @file Firestore Security Rules
 * @description This ruleset allows open read access to all collections, but restricts write access to authenticated users.
 *
 * Core Philosophy:
 *  - The application prioritizes open data access for institutions, departments, students, attendance, evaluation criteria, and grades.
 *  - Write access to professor profiles may require authentication, while all other write access is prohibited in this prototyping phase.
 *
 * Data Structure:
 *  - Data is organized into top-level collections: /institutions, /departments, /students, /attendances, /evaluation_criteria, /grades and /professor_profile.
 *  - Relationships between entities are established using document IDs (e.g., studentId in Attendance documents).
 *
 * Key Security Decisions:
 *  - Listing of documents is generally allowed for all collections, enabling open data discovery.
 *  - Schema validation is relaxed during prototyping to enable rapid iteration.  Focus is on securing access.
 *  - The professor_profile collection may in the future require authentication for writes, but for now, it allows all authenticated users.
 *
 * Denormalization for Authorization:
 *  - No denormalization is used in this initial ruleset, as access is primarily open.  Future iterations may introduce denormalization for more granular access control.
 *
 * Structural Segregation:
 *  - There is no structural segregation in this initial ruleset. All data is stored in top-level collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows any authenticated user to read and write Institution documents.
     * @path /institutions/{institutionId}
     * @allow (read, write) Allows any authenticated user to read and write institution data.
     * @principle Allows open data access for authenticated users.
     */
    match /institutions/{institutionId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Allows any authenticated user to read and write Department documents.
     * @path /departments/{departmentId}
     * @allow (read, write) Allows any authenticated user to read and write department data.
     * @principle Allows open data access for authenticated users.
     */
    match /departments/{departmentId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Allows any authenticated user to read and write Student documents.
     * @path /students/{studentId}
     * @allow (read, write) Allows any authenticated user to read and write student data.
     * @principle Allows open data access for authenticated users.
     */
    match /students/{studentId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Allows any authenticated user to write Attendance documents, and anyone to read them.
     * @path /attendances/{attendanceId}
     * @allow (read) Allows anyone to read attendance data.
     * @allow (write) Allows authenticated users to create, update, or delete attendance data.
     * @principle Allows open data access for attendance records.
     */
    match /attendances/{attendanceId} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    /**
     * @description Allows anyone to read EvaluationCriteria documents. Writes are denied.
     * @path /evaluation_criteria/{evaluationCriteriaId}
     * @allow (get, list) Allows anyone to read evaluation criteria data.
     * @deny (create, update, delete) Denies anyone from creating, updating, or deleting evaluation criteria data.
     * @principle Allows open data access for evaluation criteria.
     */
    match /evaluation_criteria/{evaluationCriteriaId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read Grade documents. Writes are denied.
     * @path /grades/{gradeId}
     * @allow (get, list) Allows anyone to read grade data.
     * @deny (create, update, delete) Denies anyone from creating, updating, or deleting grade data.
     * @principle Allows open data access for grades.
     */
    match /grades/{gradeId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows authenticated users to create, update, and delete ProfessorProfile documents.
     * @path /professor_profile/{profileId}
     * @allow (get, list) Allows anyone to read professor profile data.
     * @allow (create, update, delete) Allows authenticated users to modify professor profile data.
     * @deny (create, update, delete) Denies unauthenticated users from modifying professor profile data.
     * @principle Allows authenticated users to manage their own professor profiles.
     */
    match /professor_profile/{profileId} {
       allow get, list: if true;
       allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows authenticated users to read and write their own daily logs.
     * @path /daily_logs/{logId}
     * @allow (read, write) Allows an authenticated user to read or write a log if their UID matches the log's userId.
     * @principle Enforces ownership for daily logs.
     */
    match /daily_logs/{logId} {
        allow read, write: if isSignedIn() && request.auth.uid == resource.data.userId;
    }
  }

  // Helper function to determine if a user is signed in.
  function isSignedIn() {
    return request.auth != null;
  }
}
